import _ from"lodash";var _listening,Events={},eventSplitter=/\s+/,eventsApi=function(t,n,i,e,s){var o,r=0;if(i&&"object"==typeof i){void 0!==e&&"context"in s&&void 0===s.context&&(s.context=e);for(o=_.keys(i);r<o.length;r++)n=eventsApi(t,n,o[r],i[o[r]],s)}else if(i&&eventSplitter.test(i))for(o=i.split(eventSplitter);r<o.length;r++)n=t(n,o[r],e,s);else n=t(n,i,e,s);return n};Events.on=function(t,n,i){(this._events=eventsApi(onApi,this._events||{},t,n,{context:i,ctx:this,listening:_listening}),_listening)&&((this._listeners||(this._listeners={}))[_listening.id]=_listening,_listening.interop=!1);return this},Events.listenTo=function(t,n,i){if(!t)return this;var e=t._listenId||(t._listenId=_.uniqueId("l")),s=this._listeningTo||(this._listeningTo={}),o=_listening=s[e];o||(this._listenId||(this._listenId=_.uniqueId("l")),o=_listening=s[e]=new Listening(this,t));var r=tryCatchOn(t,n,i,this);if(_listening=void 0,r)throw r;return o.interop&&o.on(n,i),this};var onApi=function(t,n,i,e){if(i){var s=t[n]||(t[n]=[]),o=e.context,r=e.ctx,l=e.listening;l&&l.count++,s.push({callback:i,context:o,ctx:o||r,listening:l})}return t},tryCatchOn=function(t,n,i,e){try{t.on(n,i,e)}catch(t){return t}};Events.off=function(t,n,i){return this._events?(this._events=eventsApi(offApi,this._events,t,n,{context:i,listeners:this._listeners}),this):this},Events.stopListening=function(t,n,i){var e=this._listeningTo;if(!e)return this;for(var s=t?[t._listenId]:_.keys(e),o=0;o<s.length;o++){var r=e[s[o]];if(!r)break;r.obj.off(n,i,this),r.interop&&r.off(n,i)}return _.isEmpty(e)&&(this._listeningTo=void 0),this};var offApi=function(t,n,i,e){if(t){var s,o=e.context,r=e.listeners,l=0;if(n||o||i){for(s=n?[n]:_.keys(t);l<s.length;l++){var f=t[n=s[l]];if(!f)break;for(var h=[],c=0;c<f.length;c++){var v=f[c];if(i&&i!==v.callback&&i!==v.callback._callback||o&&o!==v.context)h.push(v);else{var a=v.listening;a&&a.off(n,i)}}h.length?t[n]=h:delete t[n]}return t}for(s=_.keys(r);l<s.length;l++)r[s[l]].cleanup()}};Events.once=function(t,n,i){var e=eventsApi(onceMap,{},t,n,this.off.bind(this));return"string"==typeof t&&null==i&&(n=void 0),this.on(e,n,i)},Events.onceOff=function(t,n,i,e){var s=[t,n],o=[i,e],r={call:s,off:o},l={call:o,off:s},f=function(t){var n=_.tail(arguments);t.call[1].apply(this,n),this.off(t.off[0],t.off[2])},h=_.partial(_.bind(f,this),r),c=_.partial(_.bind(f,this),l);s.push(h),o.push(c),this.once(t,h),this.once(i,c)},Events.listenToOnce=function(t,n,i){var e=eventsApi(onceMap,{},n,i,this.stopListening.bind(this,t));return this.listenTo(t,e)},Events.listenToOnceOff=function(t,n,i,e,s){var o=[n,i],r=[e,s],l={obj:t,call:o,off:r},f={obj:t,call:r,off:o},h=function(t){var n=_.tail(arguments);t.call[1].apply(this,n),this.stopListening(t.obj,t.off[0],t.off[2])},c=_.partial(_.bind(h,this),l),v=_.partial(_.bind(h,this),f);o.push(c),r.push(v),this.listenToOnce(t,n,c),this.listenToOnce(t,e,v)};var onceMap=function(t,n,i,e){if(i){var s=t[n]=_.once((function(){e(n,s),i.apply(this,arguments)}));s._callback=i}return t};Events.trigger=function(t){if(!this._events)return this;for(var n=Math.max(0,arguments.length-1),i=Array(n),e=0;e<n;e++)i[e]=arguments[e+1];return eventsApi(triggerApi,this._events,t,void 0,i),this};var triggerApi=function(t,n,i,e){if(t){var s=t[n],o=t.all;s&&o&&(o=o.slice()),s&&triggerEvents(s,e),o&&triggerEvents(o,[n].concat(e))}return t},triggerEvents=function(t,n){for(var i,e=-1,s=t.length;++e<s;)_.bind((i=t[e]).callback,i.ctx)(...n)},Listening=function(t,n){this.id=t._listenId,this.listener=t,this.obj=n,this.interop=!0,this.count=0,this._events=void 0};Listening.prototype.on=Events.on,Listening.prototype.off=function(t,n){var i;this.interop?(this._events=eventsApi(offApi,this._events,t,n,{context:void 0,listeners:void 0}),i=!this._events):(this.count--,i=0===this.count),i&&this.cleanup()},Listening.prototype.cleanup=function(){delete this.listener._listeningTo[this.obj._listenId],this.interop||delete this.obj._listeners[this.id]},Events.bind=Events.on,Events.unbind=Events.off;export{Events,Listening,eventsApi,onApi,tryCatchOn,offApi,onceMap,triggerApi,triggerEvents};