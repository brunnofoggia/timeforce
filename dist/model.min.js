import _ from"lodash";import timeforce from"./global.min.js";import{urlError,wrapError,fnfy}from"./helpers.min.js";import{Events}from"./events.min.js";import Deep from"./deep.min.js";var Model=function(t,e){var i=t||{};e||(e={}),this.setMethodsOnPrototype.apply(this),this.preinitialize.apply(this,arguments),_.each(this.preinitializePluginMethods,(t=>this[t].apply(this,arguments))),this.cid=_.uniqueId(this.cidPrefix),this.attributes={},e.collection&&(this.collection=e.collection),e.parse&&(i=this.parse(i,e)||{});var r=_.result(this,"defaults");i=_.defaultsDeep(_.extend({},r,i),r),this.set(i,e),this.changed={},_.each(this.initializePluginMethods,(t=>this[t].apply(this,arguments))),this.initialize.apply(this,arguments)};_.extend(Model.prototype,Events,timeforce.globalPrototype,{_global:timeforce,name:null,changed:null,validationError:null,idAttribute:"id",cidPrefix:"m",preinitialize:function(){},preinitializePluginMethods:[],initializePluginMethods:[],initialize:function(){},toJSON:function(){return _.cloneDeep(this.attributes)},sync:function(){return this._global.sync.apply(this,arguments)},get:function(t){return Deep.search(this.attributes,t)},escape:function(t){return _.escape(this.get(t))},has:function(t){return null!=this.get(t)},matches:function(t){return!!_.iteratee(t,this)(this.attributes)},set:function(t,e,i){if(null==t)return this;var r;if("object"==typeof t?(r=t,i=e):(r={})[t]=e,i||(i={}),!this._validate(r,i))return!1;var s=i.silent,n=[],a=this._changing;this._changing=!0,a||(this._previousAttributes=_.cloneDeep(this.attributes),this.changed={});var h=this.changed,u=this._previousAttributes,o=Deep.join(u),l=Deep.join(this.attributes),c=Deep.join(r);for(let t in c)e=c[t],_.isEqual(l[t],e)||n.push(Deep.trail(t,!0).reverse()),_.isEqual(o[t],e)?delete h[t]:h[t]=e;if(this.attributes=Deep.set(this.attributes,c,_.pick(i,"unset")),l=Deep.join(this.attributes),this.idAttribute in c){var p=this.id;this.id=this.get(this.idAttribute),this.trigger("changeId",this,p,i)}if(!s){n.length&&(this._pending=i);for(var d=0;d<n.length;d++){let t=n[d];for(var f=0;f<t.length;f++){let e=t[f];this.trigger("change:"+e,this,l[t[0]],i)}}}if(a)return this;if(!s)for(;this._pending;)i=this._pending,this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(t,e){return this.set(t,void 0,_.extend({},e,{unset:!0}))},clear:function(t){var e={};for(var i in this.attributes)e[i]=void 0;return this.set(e,_.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!_.isEmpty(this.changed):_.has(this.changed,t)},changedAttributes:function(t){if(!t)return!!this.hasChanged()&&_.cloneDeep(this.changed);var e,i=Deep.join(this._changing?this._previousAttributes:this.attributes),r={};for(var s in t){var n=t[s];_.isEqual(i[s],n)||(r[s]=n,e=!0)}return!!e&&r},previous:function(t){return null!=t&&this._previousAttributes?Deep.search(this._previousAttributes,t):null},previousAttributes:function(){return _.cloneDeep(this._previousAttributes)},fetch:function(t){t=_.extend({parse:!0,caller:"fetch"},t);var e=this,i=t.success;return t.success=function(r){var s=t.parse?e.parse(r,t):r;if(!e.set(s,t))return!1;i&&i.call(t.context,e,r,t),e.trigger("fetch",e,r,t),e.trigger("sync",e,r,t)},wrapError(this,t,"fetch"),this.sync("read",this,t)},save:function(t,e,i){var r;null==t||"object"==typeof t?(r=t,i=e):(r={})[t]=e;var s=(i=_.extend({validate:!0,validateForServer:!0,parse:!0,caller:"save"},i)).wait;if(r&&!s){if(!this.set(r,i))return!1}else if(!this._validate(r,i))return!1;var n=this,a=i.success,h=this.attributes;i.success=function(t){n.attributes=h;var e=i.parse?n.parse(t,i):t;if(s&&(e=_.extend({},r,e)),e&&!n.set(e,i))return!1;a&&a.call(i.context,n,t,i),n.trigger("save",n,t,i),n.trigger("sync",n,t,i)},wrapError(this,i,"save"),r&&s&&(this.attributes=_.extend({},h,r));var u=this.isNew()?"create":i.patch?"patch":"update";"patch"!==u||i.attrs||(i.attrs=r);var o=this.sync(u,this,i);return this.attributes=h,o},destroy:function(t){(t=t?_.clone(t):{}).caller="destroy";var e=this,i=t.success,r=t.wait,s=function(){e.stopListening(),e.trigger("destroy",e,e.collection,t)};t.success=function(n){r&&s(),i&&i.call(t.context,e,n,t),e.isNew()||e.trigger("sync",e,n,t)};var n=!1;return this.isNew()?_.defer(t.success):(wrapError(this,t,"destroy"),n=this.sync("delete",this,t)),r||s(),n},url:function(){var t=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew())return t;var e=this.get(this.idAttribute);return t.replace(/[^\/]$/,"$&/")+encodeURIComponent(e)},parse:function(t){return t},clone:function(){return new this.constructor(_.cloneDeep(this.attributes))},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},_.extend({},t,{validate:!0}))},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=_.extend({},this.attributes,t);var i=this.validationError=this.validate(t,e)||null;return!i||(this.trigger("invalid",this,i,_.extend(e,{validationError:i})),!1)}});export default Model;