import _ from"lodash";import timeforce from"./global.min.js";import{urlError,jsonToQueryString}from"./helpers.min.js";import Mock from"./mock.min.js";var Sync={emulateJSON:!1,sync:function(e,t,r,o,a){var n=methodMap[t];_.defaultsDeep(o||(o={}),{emulateJSON:timeforce.emulateJSON}),a=e.syncConfig(a||{});var l={type:n,method:n.toLowerCase(),responseType:"json",url:o.url};if(l.url||(l.url=_.result(r,"url")||urlError()),l.contentType="application/json",null==o.data&&r&&("read"===t&&r.isCollection()||"create"===t||"update"===t||"patch"===t)&&(o.data=_.cloneDeep(o.attrs)||(r.isModel()?_.cloneDeep(r.toJSON(o)):_.cloneDeep(r.form?.toJSON())||null)),r.isCollection()&&"read"===t&&o.data){l.url+=/\?/.test(l.url)?"&":"?";const e=jsonToQueryString(o.data);l.url+=o.querystring=e,o.data=null}o.emulateJSON&&(l.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:JSON.stringify(o.data)}:{}),"GET"===l.type||o.emulateJSON||(l.processData=!1);var s=o.error;o.error=function(e,t,r){o.textStatus=t,o.errorThrown=r,"function"==typeof s&&_.bind(s,o.context)(e,t,r)};var u=!0===_.result(r,"mock")||!0===_.result(e,"mock")?Mock.persist:e.persist,c=o.xhr=u(_.extend(l,o),a,r);return r.trigger("request",r,c,_.extend(l,o,{method:t})),o.caller&&r.trigger(["request",o.caller].join(":"),r,c,_.extend(l,o,{method:t})),c},syncConfig:function(e){return e}},methodMap={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};Sync.persist=function(e){return new Promise((t=>{e.success(e.data),t(e.data)}))};export default Sync;