import _ from"lodash";import timeforce from"./global.min.js";import{slice,wrapError}from"./helpers.min.js";import{Events}from"./events.min.js";var Collection=function(t,e){e||(e={}),this.setMethodsOnPrototype.apply(this),this.instanceForm.apply(this),this.preinitialize.apply(this,arguments),_.each(this.preinitializePluginMethods,(t=>this[t].apply(this,arguments))),this.cid=_.uniqueId(this.cidPrefix),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),_.each(this.initializePluginMethods,(t=>this[t].apply(this,arguments))),this.initialize.apply(this,arguments),t&&this.reset(t,_.extend({silent:!0},e))},setOptions={add:!0,remove:!0,merge:!0},addOptions={add:!0,remove:!1},splice=function(t,e,i){i=Math.min(Math.max(i,0),t.length);var s,r=Array(t.length-i),n=e.length;for(s=0;s<r.length;s++)r[s]=t[s+i];for(s=0;s<n;s++)t[s+i]=e[s];for(s=0;s<r.length;s++)t[s+n+i]=r[s]};_.extend(Collection.prototype,Events,timeforce.globalPrototype,{_global:timeforce,cidPrefix:"c",preinitialize:function(){},preinitializePluginMethods:[],initializePluginMethods:[],sendFormAsPost:!1,responseResultsField:"data",initialize:function(){},toJSON:function(t){return this.map((function(e){return e.toJSON(t)}))},sync:function(){return this._global.sync.apply(this,arguments)},add:function(t,e){return this.set(t,_.extend({merge:!1},e,addOptions))},remove:function(t,e){e=_.extend({},e);var i=!_.isArray(t);t=i?[t]:t.slice();var s=this._removeModels(t,e);return!e.silent&&s.length&&(e.changes={added:[],merged:[],removed:s},this.trigger("update",this,e)),i?s[0]:s},set:function(t,e){if(null!=t){(e=_.extend({},setOptions,e)).parse&&!this._isModel(t)&&(t=this.parse(t,e)||[]);var i=!_.isArray(t);t=i?[t]:t.slice();var s=e.at;null!=s&&(s=+s),s>this.length&&(s=this.length),s<0&&(s+=this.length+1);var r,n,o=[],l=[],h=[],d=[],a={},c=e.add,u=e.merge,f=e.remove,m=!1,p=this.comparator&&null==s&&!1!==e.sort,g=_.isString(this.comparator)?this.comparator:null;for(n=0;n<t.length;n++){r=t[n];var v=this.get(r);if(v){if(u&&r!==v){var y=this._isModel(r)?r.attributes:r;e.parse&&(y=v.parse(y,e)),v.set(y,e),h.push(v),p&&!m&&(m=v.hasChanged(g))}a[v.cid]||(a[v.cid]=!0,o.push(v)),t[n]=v}else c&&(r=t[n]=this._prepareModel(r,e))&&(l.push(r),this._addReference(r,e),a[r.cid]=!0,o.push(r))}if(f){for(n=0;n<this.length;n++)a[(r=this.models[n]).cid]||d.push(r);d.length&&this._removeModels(d,e)}var I=!1,b=!p&&c&&f;if(o.length&&b?(I=this.length!==o.length||_.some(this.models,(function(t,e){return t!==o[e]})),this.models.length=0,splice(this.models,o,0),this.length=this.models.length):l.length&&(p&&(m=!0),splice(this.models,l,null==s?this.length:s),this.length=this.models.length),m&&this.sort({silent:!0}),!e.silent){for(n=0;n<l.length;n++)null!=s&&(e.index=s+n),(r=l[n]).trigger("add",r,this,e);(m||I)&&this.trigger("sort",this,e),(l.length||d.length||h.length)&&(e.changes={added:l,removed:d,merged:h},this.trigger("update",this,e))}return i?t[0]:t}},reset:function(t,e){e=e?_.clone(e):{};for(var i=0;i<this.models.length;i++)this._removeReference(this.models[i],e);return e.previousModels=this.models,this._reset(),t=this.add(t,_.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),t},push:function(t,e){return this.add(t,_.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t)},unshift:function(t,e){return this.add(t,_.extend({at:0},e))},shift:function(t){var e=this.at(0);return this.remove(e,t)},slice:function(){return slice.apply(this.models,arguments)},get:function(t){if(null!=t)return this._byId[t]||this._byId[this.modelId(this._isModel(t)?t.attributes:t,t.idAttribute)]||t.cid&&this._byId[t.cid]},has:function(t){return null!=this.get(t)},at:function(t){return t<0&&(t+=this.length),this.models[t]},where:function(t,e){return this[e?"find":"filter"](t)},findWhere:function(t){return this.where(t,!0)},sort:function(t){var e=this.comparator;if(!e)throw new Error("Cannot sort a set without a comparator");t||(t={});var i=e.length;return _.isFunction(e)&&(e=e.bind(this)),1===i||_.isString(e)?this.models=this.sortBy(e):this.models.sort(e),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return this.map(t+"")},fetch:function(t){var e=(t=_.extend({parse:!0,caller:"fetch"},t)).success,i=this,s="read";return t.success=function(s){var r=!(!s||_.isArray(s)),n=r?s[i.responseResultsField]:s,o=t.reset?"reset":"set";i[o](n,t),r&&i.setForm(_.omit(s,i.responseResultsField)),e&&e.call(t.context,i,s,t),i.trigger("fetch",i,s,t),i.trigger("sync",i,s,t)},wrapError(this,t,"fetch"),this.form&&_.result(this,"sendFormAsPost")&&(s="create"),this.sync(s,this,t)},create:function(t,e){var i=(e=e?_.clone(e):{}).wait;if(!(t=this._prepareModel(t,e)))return!1;i||this.add(t,e);var s=this,r=e.success;return e.success=function(t,e,n){i&&s.add(t,n),r&&r.call(n.context,t,e,n)},t.save(null,e),t},parse:function(t){return t},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(t,e){return t[e||this.model.prototype.idAttribute||"id"]},values:function(){return new CollectionIterator(this,ITERATOR_VALUES)},keys:function(){return new CollectionIterator(this,ITERATOR_KEYS)},entries:function(){return new CollectionIterator(this,ITERATOR_KEYSVALUES)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){return this._isModel(t)?(t.collection||(t.collection=this),t):((e=e?_.clone(e):{}).collection=this,(i=this.model.prototype?new this.model(t,e):this.model(t,e)).validationError?(this.trigger("invalid",this,i.validationError,e),!1):i);var i},_removeModels:function(t,e){for(var i=[],s=0;s<t.length;s++){var r=this.get(t[s]);if(r){var n=this.indexOf(r);this.models.splice(n,1),this.length--,delete this._byId[r.cid];var o=this.modelId(r.attributes,r.idAttribute);null!=o&&delete this._byId[o],e.silent||(e.index=n,r.trigger("remove",r,this,e)),i.push(r),this._removeReference(r,e)}}return i},_addReference:function(t){this._byId[t.cid]=t;var e=this.modelId(t.attributes,t.idAttribute);null!=e&&(this._byId[e]=t),t.on("all",this._onModelEvent,this)},_removeReference:function(t){delete this._byId[t.cid];var e=this.modelId(t.attributes,t.idAttribute);null!=e&&delete this._byId[e],this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,s){if(e){if(("add"===t||"remove"===t)&&i!==this)return;if("destroy"===t&&this.remove(e,s),"changeId"===t){var r=this.modelId(e.previousAttributes(),e.idAttribute),n=this.modelId(e.attributes,e.idAttribute);null!=r&&delete this._byId[r],null!=n&&(this._byId[n]=e)}}this.trigger.apply(this,arguments)},setForm(){return this.form.set.apply(this.form,arguments)},instanceForm(){if(!this.form){var t=this._global.Model;this.form=new t}},getForm(){return this.form}});var $$iterator="function"==typeof Symbol&&Symbol.iterator;$$iterator&&(Collection.prototype[$$iterator]=Collection.prototype.values);var CollectionIterator=function(t,e){this._collection=t,this._kind=e,this._index=0},ITERATOR_VALUES=1,ITERATOR_KEYS=2,ITERATOR_KEYSVALUES=3;$$iterator&&(CollectionIterator.prototype[$$iterator]=function(){return this}),CollectionIterator.prototype.next=function(){if(this._collection){if(this._index<this._collection.length){var t,e=this._collection.at(this._index);if(this._index++,this._kind===ITERATOR_VALUES)t=e;else{var i=this._collection.modelId(e.attributes);t=this._kind===ITERATOR_KEYS?i:[i,e]}return{value:t,done:!1}}this._collection=void 0}return{value:void 0,done:!0}};export default Collection;